name: CI-CD Spring Boot Full

on:
  push:
    branches: 
      - '**'  # toutes les branches
    paths-ignore:
      - '**/README.md'
  pull_request:
    branches:
      - '**'

env:
  SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
  SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
  SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}

jobs:

  build:
    name: Build & Upload Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build project without tests
        run: mvn clean install -DskipTests 

      - name: Prepare artifact
        run: |
          mkdir -p staging
          cp target/*.jar staging/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-final
          path: staging
          if-no-files-found: error

 
  docker:
   - name: Build Docker image
     run: |
        # Nettoyer le nom de branche pour un tag Docker valide
        if [[ "$GITHUB_REF" == refs/pull/* ]]; then
          # C'est une Pull Request
          PR_NUMBER=$(echo "$GITHUB_REF" | sed 's/refs\/pull\/\([0-9]*\)\/.*/\1/')
          BRANCH_TAG="pr-$PR_NUMBER"
        else
          # C'est une branche normale
          BRANCH_TAG=${GITHUB_REF#refs/heads/}
        fi
        
        # Nettoyer les caractères non autorisés
        BRANCH_TAG=$(echo "$BRANCH_TAG" | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
        
        echo "Tag utilisé: $BRANCH_TAG"
        
        docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.DOCKER_HUB_NAME }}:$BRANCH_TAG staging/
        
        # Ne taguer "latest" que pour main
        if [ "$BRANCH_TAG" = "main" ]; then
          docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.DOCKER_HUB_NAME }}:$BRANCH_TAG \
                    ${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.DOCKER_HUB_NAME }}:latest
        fi
      
  deploy:
    name: Deployment
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - name: Deployment placeholder
        run: echo "Déploiement configuré uniquement pour la branche main"